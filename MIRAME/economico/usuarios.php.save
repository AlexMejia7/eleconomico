<?php
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET, POST, PUT, DELETE");
header("Access-Control-Allow-Headers: Content-Type");

// Incluye conexión a la base de datos
include_once('database.php');
$database = new Database();
$db = $database->getConnection();

$method = $_SERVER['REQUEST_METHOD'];

switch ($method) {
    case 'GET':
        if (isset($_GET['id'])) {
            $stmt = $db->prepare("SELECT * FROM usuarios WHERE id_usuario = ?");
            if ($stmt->execute([$_GET['id']])) {
                $usuario = $stmt->fetch(PDO::FETCH_ASSOC);
                if ($usuario) {
                    unset($usuario['contrasena']); // No mostrar contraseña
                    echo json_encode($usuario);
                } else {
                    http_response_code(404);
                    echo json_encode(["mensaje" => "Usuario no encontrado"]);
                }
            } else {
                http_response_code(500);
                echo json_encode(["mensaje" => "Error en la consulta"]);
            }
        } else {
            $stmt = $db->query("SELECT * FROM usuarios");
            $usuarios = $stmt->fetchAll(PDO::FETCH_ASSOC);
            foreach ($usuarios as &$u) {
                unset($u['contrasena']);
            }
            echo json_encode($usuarios);
        }
        break;

    case 'POST':
        $data = json_decode(file_get_contents("php://input"), true);
        if (!isset($data['nombre'], $data['correo'], $data['contrasena'])) {
            http_response_code(400);
            echo json_encode(["mensaje" => "Faltan datos obligatorios: nombre, correo o contrasena"]);
            break;
        }

        // Texto plano para contraseña, como pediste
        $hashedPassword = $data['contrasena'];

        $rol = $data['rol'] ?? 'usuario';

        $stmt = $db->prepare(
            "INSERT INTO usuarios 
            (nombre, correo, contrasena, foto_perfil_base64, descripcion, ubicacion_gps, codigo_verificacion, verificado, api_key, rol) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)"
        );

        $params = [
            $data['nombre'],
            $data['correo'],
            $hashedPassword,
            $data['foto_perfil_base64'] ?? null,
            $data['descripcion'] ?? null,
            $data['ubicacion_gps'] ?? null,
            $data['codigo_verificacion'] ?? null,
            0, // verificado inicialmente en 0
            null, // api_key null
            $rol
        ];

        if ($stmt->execute($params)) {
            echo json_encode([
                "mensaje" => "Usuario creado",
                "id" => $db->lastInsertId()
            ]);
        } else {
            http_response_code(500);
            echo json_encode(["mensaje" => "Error al crear usuario"]);
        }
        break;

    case 'PUT':
        if (!isset($_GET['id'])) {
            http_response_code(400);
            echo json_encode(["mensaje" => "Se necesita id para actualizar"]);
            break;
        }

        $data = json_decode(file_get_contents("php://input"), true);
        $id = $_GET['id'];

        $fields = [];
        $values = [];

        foreach (['nombre', 'correo', 'contrasena', 'foto_perfil_base64', 'descripcion', 'ubicacion_gps', 'rol'] as $field) {
            if (isset($data[$field])) {
                $fields[] = "$field = ?";
                $values[] = $data[$field];
            }
        }


